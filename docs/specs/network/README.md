# ReuseBackup ネットワーク仕様書

## 概要

ReuseBackupアプリケーション間のネットワーク通信とサーバー発見機能の外部仕様書です。

## ネットワーク構成

### 基本構成
- **通信方向**: クライアント → サーバー（一方向）
- **ネットワーク**: ローカルネットワーク内のみ
- **プロトコル**: HTTP/1.1 over TCP
- **サービス発見**: Bonjour (mDNS/DNS-SD)

### 前提条件
- **WiFi接続**: 両デバイスが同じWiFiネットワークに接続
- **ファイアウォール**: ポート8080が開放されている
- **mDNS対応**: ネットワーク機器がmDNSに対応している

## Bonjourサービス発見

### サービス仕様
- **サービスタイプ**: `_reuse-backup._tcp`
- **ドメイン**: `local.`
- **ポート**: 8080（デフォルト）
- **サービス名**: デバイス固有の識別子

### 発見プロセス

#### サーバー側（ReuseBackupServer）
1. **サービス登録**: アプリ起動時にBonjourサービスを登録
2. **サービス名**: デバイス名またはUUID
3. **TXTレコード**: 追加のサービス情報（バージョン等）
4. **アドバタイズ**: ネットワーク上にサービスを広告

#### クライアント側（ReuseBackupClient）
1. **サービス検索**: `_reuse-backup._tcp.local.`サービスを検索
2. **サービス解決**: 発見されたサービスのIPアドレス・ポート解決
3. **サービス一覧**: 発見されたサーバーの一覧表示
4. **接続確認**: 各サーバーの生存確認

### 発見されるサーバー情報
- **サーバー名**: Bonjourサービス名
- **IPアドレス**: サーバーのローカルIPアドレス
- **ポート番号**: サーバーのリスニングポート
- **エンドポイント**: `http://[IP]:[PORT]`形式

## HTTP通信

### 通信設定
- **プロトコル**: HTTP/1.1
- **ポート**: 8080（デフォルト）
- **タイムアウト**: 30秒（接続・読み取り）
- **Keep-Alive**: 対応
- **圧縮**: 未対応

### 通信フロー
1. **サーバー発見**: Bonjourでサーバーを発見
2. **接続確認**: `/api/status`でサーバー状態確認
3. **メッセージ送信**: `/api/message`でメッセージ送信
4. **レスポンス処理**: サーバーからのレスポンス処理

## 手動サーバー追加

### 対応フォーマット
- **IPアドレス:ポート**: `192.168.1.100:8080`
- **IPアドレスのみ**: `192.168.1.100`（ポート8080を仮定）
- **ホスト名:ポート**: `server.local:8080`

### 検証プロセス
1. **フォーマット検証**: 入力されたアドレスの形式確認
2. **接続テスト**: 指定されたサーバーへの接続試行
3. **API確認**: `/api/status`でサーバー応答確認
4. **一覧追加**: 確認されたサーバーを発見済み一覧に追加

## エラーハンドリング

### ネットワークエラー
- **接続タイムアウト**: サーバーへの接続が30秒でタイムアウト
- **接続拒否**: サーバーがポートを開放していない
- **ネットワーク切断**: WiFi接続が切断された
- **DNS解決失敗**: ホスト名の解決に失敗

### Bonjourエラー
- **サービス未発見**: 指定されたサービスが見つからない
- **解決失敗**: 発見されたサービスのIPアドレス解決に失敗
- **権限エラー**: ローカルネットワーク権限がない

### 復旧処理
- **自動再試行**: 一定間隔での自動再接続試行
- **手動再試行**: ユーザーによる手動再試行
- **エラー表示**: ユーザーへのエラー状況通知

## セキュリティ

### 現在の実装
- **暗号化**: なし（平文HTTP通信）
- **認証**: なし
- **アクセス制御**: なし

### 制限事項
- **ローカルネットワーク限定**: 同一ネットワーク内のみ通信可能
- **信頼できるネットワーク**: セキュアなWiFi環境での使用を推奨
- **機密データ**: 重要な情報の送信は避ける

## パフォーマンス

### 通信性能
- **レイテンシー**: ローカルネットワーク内（通常1-10ms）
- **スループット**: WiFi速度に依存
- **同時接続**: 制限なし（サーバー能力に依存）

### 発見性能
- **発見時間**: 通常1-3秒
- **更新頻度**: 30秒間隔での状態更新
- **キャッシュ**: 発見済みサーバーの情報キャッシュ

## 関連仕様

- **[API仕様](../api/README.md)** - HTTP API詳細
- **[サーバーアプリ仕様](../server/README.md)** - サーバー側ネットワーク実装
- **[クライアントアプリ仕様](../client/README.md)** - クライアント側ネットワーク実装
- **[サーバー発見機能](../features/server-discovery.md)** - サーバー発見機能詳細