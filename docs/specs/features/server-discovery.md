# サーバー発見機能仕様書

## 概要

ReuseBackupクライアントアプリケーションにおけるサーバー自動発見および手動追加機能の外部仕様書です。

## 機能概要

### 主要機能
- **自動発見**: Bonjourを使用したサーバー自動発見
- **手動追加**: IPアドレスによる手動サーバー追加
- **状態監視**: 発見されたサーバーの状態監視
- **接続管理**: サーバーへの接続状態管理

## 自動発見機能

### Bonjourサーバー発見
- **サービス検索**: `_reuse-backup._tcp.local.`サービスの検索
- **リアルタイム発見**: ネットワーク上のサーバーをリアルタイムで発見
- **自動更新**: サーバー状態の自動更新
- **発見通知**: 新しいサーバー発見時の通知

### 発見プロセス
1. **検索開始**: アプリ起動時またはユーザー操作による検索開始
2. **サービス発見**: ネットワーク上のBonjourサービス発見
3. **サービス解決**: 発見されたサービスのIPアドレス・ポート解決
4. **一覧表示**: 発見されたサーバーの一覧表示
5. **状態確認**: 各サーバーの生存確認・状態取得

### 発見状態表示
- **検索中**: プログレスインジケーターとテキスト表示
- **発見完了**: 発見されたサーバー数の表示
- **未発見**: サーバーが見つからない場合の表示
- **エラー**: 発見プロセスでのエラー表示

## 手動サーバー追加

### 対応フォーマット
- **IPアドレス:ポート**: `192.168.1.100:8080`
- **IPアドレスのみ**: `192.168.1.100`（ポート8080を仮定）
- **ホスト名:ポート**: `server.local:8080`
- **ホスト名のみ**: `server.local`（ポート8080を仮定）

### 入力検証
- **フォーマット検証**: 入力されたアドレスの形式確認
- **IPアドレス検証**: 有効なIPアドレス形式の確認
- **ポート番号検証**: 有効なポート番号範囲の確認
- **空文字検証**: 空文字入力の防止

### 追加プロセス
1. **アドレス入力**: テキストフィールドでのアドレス入力
2. **フォーマット検証**: 入力されたアドレスの形式確認
3. **接続テスト**: 指定されたサーバーへの接続試行
4. **API確認**: `/api/status`でサーバー応答確認
5. **一覧追加**: 確認されたサーバーを発見済み一覧に追加

## サーバー一覧表示

### 表示情報
- **サーバー名**: Bonjourサービス名またはIPアドレス
- **エンドポイント**: `http://[IP]:[PORT]`形式
- **接続状態**: オンライン/オフライン状態
- **サーバーステータス**: 稼働状態（running/starting/stopping）
- **稼働時間**: サーバーの稼働時間（時間:分形式）
- **バージョン**: サーバーアプリのバージョン

### 状態インジケーター
- **オンライン**: 緑色のチェックマーク
- **オフライン**: 赤色のバツマーク
- **確認中**: プログレスインジケーター

## サーバー状態監視

### 状態確認
- **定期確認**: 30秒間隔での状態確認
- **手動確認**: ユーザーによる手動更新
- **接続テスト**: HTTP GETリクエストによる生存確認
- **応答時間**: サーバー応答時間の測定

### 状態更新
- **リアルタイム更新**: 状態変更の即座の反映
- **キャッシュ管理**: 前回の状態情報キャッシュ
- **エラー処理**: 状態確認エラー時の処理

## ユーザーインターフェース

### 発見状態セクション
- **検索中表示**: プログレスインジケーター + "サーバーを検索中..."
- **結果表示**: 発見サーバー数の表示
- **未発見表示**: "サーバーが見つかりません"
- **説明テキスト**: 同一ネットワーク上でのサーバー起動確認案内

### サーバー一覧セクション
- **リスト表示**: 発見されたサーバーの一覧
- **詳細情報**: 各サーバーの詳細情報表示
- **状態アイコン**: 視覚的な状態表示
- **空状態**: サーバーが見つからない場合の表示

### 手動追加セクション
- **入力フィールド**: IPアドレス・ポート入力
- **プレースホルダー**: "例: 192.168.1.100:8080"
- **追加ボタン**: サーバー追加実行ボタン
- **入力検証**: リアルタイムでの入力検証

### 操作機能
- **再検索ボタン**: ツールバーの再検索ボタン
- **プルリフレッシュ**: 画面引き下げでの再検索
- **検索中無効化**: 検索中の操作ボタン無効化

## エラーハンドリング

### 自動発見エラー
- **ネットワーク権限エラー**: ローカルネットワークアクセス権限不足
- **サービス未発見**: 指定されたBonjourサービスが見つからない
- **解決失敗**: 発見されたサービスのIPアドレス解決失敗
- **タイムアウト**: 発見処理のタイムアウト

### 手動追加エラー
- **無効フォーマット**: 入力されたアドレスの形式エラー
- **接続失敗**: 指定されたサーバーへの接続失敗
- **サーバー応答なし**: サーバーからの応答なし
- **API非対応**: 指定されたサーバーがAPIに対応していない

### 状態監視エラー
- **接続タイムアウト**: サーバー状態確認のタイムアウト
- **ネットワーク切断**: WiFi接続の切断
- **サーバー停止**: サーバーの停止検出

### エラー表示
- **アラート表示**: 重要なエラーのアラート表示
- **インライン表示**: 状態エラーのインライン表示
- **再試行オプション**: エラー発生時の再試行機能提供

## パフォーマンス

### 発見性能
- **発見時間**: 通常1-3秒でサーバー発見
- **更新頻度**: 30秒間隔での状態更新
- **キャッシュ**: 発見済みサーバー情報のキャッシュ

### 応答性
- **UI応答性**: 発見処理中もUI操作可能
- **非同期処理**: バックグラウンドでの発見処理
- **プログレス表示**: 処理中の進捗表示

## 関連仕様

- **[ネットワーク仕様](../network/README.md)** - Bonjourサービス発見詳細
- **[API仕様](../api/README.md)** - サーバー状態API詳細
- **[クライアントアプリ仕様](../client/README.md)** - クライアント側UI詳細
- **[サーバーアプリ仕様](../server/README.md)** - サーバー側Bonjourサービス詳細